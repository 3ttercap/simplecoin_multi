{% extends "base.html" %}
{% block body %}

<script>
$(document).ready(function() {

  d3.json('/static/js/stackedAreaData.json', function(data) {
    nv.addGraph(function() {
      var chart = nv.models.stackedAreaChart()
                    .margin({right: 100})
                    .x(function(d) { return d[0] })   //We can modify the data accessor functions...
                    .y(function(d) { return d[1] })   //...in case your data is formatted differently.
                    .useInteractiveGuideline(true)    //Tooltips which show all data points. Very nice!
                    .transitionDuration(500)
                    .showControls(true)       //Allow user to choose 'Stacked', 'Stream', 'Expanded' mode.
                    .clipEdge(true);

      //Format x-axis labels with custom function.
      chart.xAxis
          .tickFormat(function(d) {
            return d3.time.format('%x')(new Date(d))
      });

      chart.yAxis
          .tickFormat(d3.format(',.2f'));

      d3.select('#chart svg')
        .datum(data)
        .call(chart);

      nv.utils.windowResize(chart.update);

      return chart;
    });
  })


  var last_10min = 0;
  generate_graph("{{ username }}/stats", ".awesome");
  setTimeout(function(){

    var hashrate, seconds, mhashpersec, user_shares, est_payout,
        round_reward, shares_to_solve, percentage_value, dogerate, day_shares;

    round_reward = {{ round_reward }};
    user_shares = {{ user_shares }};

    {# Calculate est round payout  #}
    shares_to_solve = {{ g.current_difficulty }} * Math.pow(2, 16);
    percentage_value = user_shares / shares_to_solve;
    est_payout = ((percentage_value * round_reward)) * .99;

    {# Calculate mhashes/sec  #}
    seconds = 60000;
    hashrate = Math.pow(2, 16) * window.last_10min;
    mhashpersec = (hashrate / seconds) / 1000;

    {# Calculate est doge per day  #}
    day_shares = (window.last_10min * 60 * 24);
    percentage_value = day_shares / shares_to_solve;
    dogerate = ((percentage_value * round_reward)) * .99;

    setInterval(function(){
      $('.odometer.hashrate').text(Math.round(mhashpersec * 1000) / 1000);
      $('.odometer.usershares').text(Math.round(user_shares));
      $('.odometer.estpayout').text(Math.round(est_payout * 1000000) / 1000000);
      $('.odometer.dogerate').text(Math.round(dogerate * 1000) / 1000);
    },1000);


},1000);

});
</script>



<div class="container">
  <div class="row page-header">
    <h2>User Stats - {{ username }}</h2>
    <br>
    <div class="col-lg-3">
      <div class="panel panel-default">
        <div class="panel-body text-center">
          <small>Round Shares:</small> <br><h4><p><span class="odometer usershares"></span></p></h4>
        </div>
      </div>
    </div>
    <div class="col-lg-3">
      <div class="panel panel-default">
        <div class="panel-body text-center">
          <small>Est round payout:</small> <br><h4><p><span class="odometer estpayout"></span> &ETH;</p></h4>
        </div>
      </div>
    </div>
    <div class="col-lg-3">
      <div class="panel panel-default">
        <div class="panel-body text-center">
          <small>10 min hashrate:</small> <br><h4><p><span class="odometer hashrate"></span> MHashes/sec</p></h4>
        </div>
      </div>
    </div>
    <div class="col-lg-3">
      <div class="panel panel-default">
        <div class="panel-body text-center">
          <small>Doge/day (Est. from 10 min hashrate):</small> <br><h4><p><span class="odometer dogerate"></span> &ETH;</p></h4>
        </div>
      </div>
    </div>

  </div>
  <div class="row row-header">
    <div class="col-lg-10 col-lg-offset-1">
      <div id="chart" style="height:400px;"><svg></svg></div>
    </div>
  </div>
  <div class="row row-header" style="padding-top:50px;">
    <h2>Account</h2>
    <br>
    <div class="col-lg-3">
      <div class="panel panel-default">
        <div class="panel-body text-center">
          <small>Balance:</small> <br><h4><p>{{ balance / 100000000 }}</p></h4>
        </div>
      </div>
    </div>
    <div class="col-lg-3">
      <div class="panel panel-default">
        <div class="panel-body text-center">
          <small>Unconfirmed balance:</small> <br><h4><p>{{ unconfirmed_balance / 100000000 }}</p></h4>
        </div>
      </div>
    </div>
    <div class="col-lg-3">
      <div class="panel panel-default">
        <div class="panel-body text-center">
          <small>Total earned:</small> <br><h4><p>{{ total_earned / 100000000 }}</p></h4>
        </div>
      </div>
    </div>
    <div class="col-lg-3">
      <div class="panel panel-default">
        <div class="panel-body text-center">
          <small>Total paid:</small> <br><h4><p>{{ total_paid }}</p></h4>
        </div>
      </div>
    </div>
    {% if payouts %}
    <div class="col-lg-12">
      <div class="bs-example table-responsive">
        <table class="table table-striped table-hover ">
          <thead>
            <tr>
              <th>Time</th>
              <th>Shares Contributed</th>
              <th>Amount</th>
              <th>Blockheight</th>
              <th>TX id</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for payout in payouts %}
            <tr>
              <th>{{ payout.block.found_at | time_ago }}</th>
              <th>{{ payout.shares }}</th>
              <th>{{ payout.amount }}</th>
              <th>{{ payout.blockheight }}</th>
              <th>{{ payout.transaction_id }}</th>
              <th>{% if payout.block.mature %}Confirmed{% else %}Unconfirmed{% endif %}</th>
            </tr>
            {% endfor %}

          </tbody>
        </table>
      </div>
    </div>
    {% else %}
    <div class="text-center"><h3>No payouts for this user yet</h3></div>
    {% endif %}
  </div>

{% endblock %}
